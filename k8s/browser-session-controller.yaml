apiVersion: v1
kind: ServiceAccount
metadata:
  name: browser-session-controller
  namespace: omicron-browser
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: browser-session-controller
  namespace: omicron-browser
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "endpoints"]
    verbs: ["create", "get", "list", "watch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: browser-session-controller
  namespace: omicron-browser
subjects:
  - kind: ServiceAccount
    name: browser-session-controller
    namespace: omicron-browser
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: browser-session-controller
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: browser-session-controller
  namespace: omicron-browser
spec:
  replicas: 1
  selector:
    matchLabels:
      app: browser-session-controller
  template:
    metadata:
      labels:
        app: browser-session-controller
    spec:
      serviceAccountName: browser-session-controller
      containers:
        - name: controller
          image: ghcr.io/yourorg/browser-session-controller:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8090
          env:
            - name: SUPABASE_URL
              valueFrom:
                secretKeyRef:
                  name: browser-session-controller-env
                  key: SUPABASE_URL
            - name: SUPABASE_SERVICE_ROLE_KEY
              valueFrom:
                secretKeyRef:
                  name: browser-session-controller-env
                  key: SUPABASE_SERVICE_ROLE_KEY
            - name: BROWSER_SESSION_CONTROLLER_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: browser-session-controller-env
                  key: BROWSER_SESSION_CONTROLLER_JWT_SECRET
            - name: BROWSER_RUNNER_BROKER_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: browser-session-controller-env
                  key: BROWSER_RUNNER_BROKER_JWT_SECRET
            - name: BROWSER_RUNNER_IMAGE
              valueFrom:
                secretKeyRef:
                  name: browser-session-controller-env
                  key: BROWSER_RUNNER_IMAGE
            - name: BROWSER_RUNNER_ARTIFACTS_S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: browser-session-controller-env
                  key: BROWSER_RUNNER_ARTIFACTS_S3_BUCKET
                  optional: true
            - name: BROWSER_RUNNER_ARTIFACTS_S3_PREFIX_BASE
              value: "pw-videos"
            - name: BROWSER_SESSION_CONTROLLER_INTERNAL_URL
              value: "http://browser-session-controller.omicron-browser.svc.cluster.local:8090"
            - name: BROWSER_RUNNER_NAMESPACE
              value: "omicron-browser"
            - name: BROWSER_RUNNER_SERVICE_ACCOUNT_NAME
              value: "pw-runner"
            - name: BROWSER_SESSION_TTL_SECONDS_DEFAULT
              value: "600"
          readinessProbe:
            httpGet:
              path: /docs
              port: http
            initialDelaySeconds: 2
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: browser-session-controller
  namespace: omicron-browser
spec:
  type: ClusterIP
  selector:
    app: browser-session-controller
  ports:
    - name: http
      port: 8090
      targetPort: http

